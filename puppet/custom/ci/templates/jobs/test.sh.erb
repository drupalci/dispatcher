#!/bin/bash

cd /opt/testbot
sudo git pull origin master

# Clean up the workspace prior to running the build.
TMP_DIR='/tmp/build'
rm -fR $TMP_DIR
git clone --depth 1 --branch ${branch} ${repository} $TMP_DIR
cd $TMP_DIR

# Apply the patch.
if [ ! -z "${patch}" ]; then
  curl ${patch} | git apply
fi

##
# Run the test suite build here...
##

# sudo swapoff -a
# sudo dd if=/dev/zero of=/var/swapfile bs=1M count=2048
# sudo chmod 600 /var/swapfile
# sudo mkswap /var/swapfile
# sudo swapon /var/swapfile
# sudo /bin/echo "/var/swapfile swap swap defaults 0 0" >>/etc/fstab

## Re-enabled 4/6/15
sudo apt-get update
sudo apt-get install -y git mc ssh gawk grep sudo htop mysql-client php5-cli curl
sudo apt-get autoclean

git clone git://git.drupal.org/project/drupalci_testbot.git --branch production
cd drupalci_testbot
sudo composer install --prefer-dist --no-progress
sudo ./drupalci config:set DCI_Concurrency=8
sudo ./drupalci run simpletest

## Disabled 4/6/15
# cd /opt/testbot
# sudo ./scripts/start_dbcontainers.sh
# sudo DCI_IDENTIFIER=$BUILD_NUMBER DCI_WORKSPACE=$TMP_DIR DCI_DRUPALBRANCH="8.0.x" /opt/testbot/scripts/run.sh

# Report on the progress.
sudo wget https://github.com/drupalci/results/releases/download/0.0.2/results-cli-0.0.2
sudo mv results-cli-0.0.2 /usr/local/bin/results-cli
sudo chmod a+x /usr/local/bin/results-cli

results-cli summary --build=${results} --sqlite="/home/ubuntu/testbotdata/${BUILD_NUMBER}/test.sqlite"
results-cli progress --build=${results} --state="4"
